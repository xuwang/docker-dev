#!/bin/bash
set -e #-x

APPS=${APPS:-/mnt/apps}

SCRIPT_HOME="$( cd "$( dirname "$0" )" && pwd )"
. $SCRIPT_HOME/env.sh

# get ids of all containers that matches $1
app_ids(){
    if [ -z $1 ]
    then    
        docker ps -a -q
    else
        docker ps -a | awk '{ print $1,$2}' | grep $1 | awk '{ print $1 }'
    fi
}

killz(){
	echo "Killing all docker containers: $1"
	ids=`app_ids $1`
	ids=`docker ps -a -q`
	if [ -n "$ids" ]; then
		echo $ids | xargs docker kill
		echo $ids | xargs docker rm
	fi
}

stop(){
    echo "Stopping all docker containers: $1"
	ids=`app_ids $1`
	if [ -n "$ids" ]; then
		echo $ids | xargs docker stop
		echo $ids | xargs docker rm
	fi
}

start(){
    # start specific app defined in $2 or start all apps
    if [ -z $1 ]
    then
        for apps in \
            shipyard \
            #registry-ui \
            #zookeeper \
            #kafka \
            #mysql 
        do
            if ! is_running $apps; then $"start-$apps"; fi
        done
    else
        if ! is_running $1; then $"start-$1"; fi
	fi
    
	echo ============================================
	echo All container started!
	docker ps -a
}

update(){
	cp /vagrant/etc/docker.conf /etc/init/docker.conf
    # pull specific image defined in $2 or pull all
    if [ -z $1 ]
    then
        for im in \
            #redis \
            #zookeeper \
            #kafka \
            #mysql \
            #sendbox
        do
            echo pull $DOCKER_REPO/${im}:latest
            docker pull $DOCKER_REPO/${im}:latest 
        done
    else
        echo pull $DOCKER_REPO/$1:latest
        docker pull $DOCKER_REPO/$1:latest 
	fi
}

case "$1" in
	restart)
		stop $2
		start $2
		;;
	start)
	    start $2
		;;
	stop)
		stop $2
		;;
	kill)
		killz $2
		;;
	update)
		update $2
		;;
	status)
		docker info
		docker ps -a
		;;
	*)
		echo $"Usage: $0 {start|stop|kill|update|restart|status}"
		RETVAL=1
esac
