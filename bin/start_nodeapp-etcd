#!/bin/bash

# See http://adetante.github.io/articles/service-discovery-with-docker-2

set -e #-x

APPS=${APPS:-/mnt/apps}

SCRIPT_HOME="$( cd "$( dirname "$0" )" && pwd )"
. $SCRIPT_HOME/env.sh

#build first
dockbuild_if_missing nodeapp-etcd

if ! is_running etcd; then start_etcd; fi

# for multi-host use the host ip as the service ip vs container's ip
# SERVICE_IP=${NODE_IP=`/sbin/ifconfig eth0 | awk -F ' *|:' '/inet addr/{print $4}'`}
# SERVICE_PORT=<host port of the service>
# docker run -d -p ${SERVICE_PORT}:8000 --link etcd:etcd -e SERVICE_IP=$SERVICE_IP -e SERVICE_PORT=$SERVICE_PORT

NODEAPP=$(docker run \
	-d \
	-p 8000 \
	--link etcd:etcd \
	nodeapp-etcd
	)

echo "Started nodeapp-etcd in container $NODEAPP"